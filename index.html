<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoramento de ECG com Plotly</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        .container {
            display: flex;
            margin-top: 50px;
            flex-direction: column;
            align-items: center;
        }

        #ecgChart, #ecgChartInfinite {
            width: 100%;
            height: 500px;
            margin-bottom: 30px;
        }

        .captures-container {
            display: flex;
            margin-top: 20px;
        }

        .capture {
            width: 100px;
            height: 100px;
            margin: 5px;
            border: 1px solid #ddd;
        }

        #textOutput {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            background-color: #f4f4f4;
            max-width: 500px;
            word-wrap: break-word;
        }

        #saveButton {
            margin-top: 20px;
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }

        #saveButton:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Monitoramento de ECG</h2>
        <div id="ecgChart"></div>
        <div id="ecgChartInfinite"></div>
        <h4>Texto de Dados Recebidos</h4>
        <div id="textOutput" class="alert alert-secondary">Aguardando dados...</div>
        <div class="captures-container" id="capturesContainer"></div>
        <button id="saveButton">Salvar Capturas</button>
    </div>

    <script>
        // Dados do gráfico reiniciável
        const ecgData = { x: [], y: [] };

        // Dados do gráfico contínuo
        const infiniteEcgData = { x: [], y: [] };

        let xPosition = 0;
        let restingTime = 0;
        let heartRate = 1;
        let abnormalRate = false;
        let biphasicMode = false;
        let nextAbnormal = Math.random() * 10;
        let captureIndex = 0;

        const layout = {
            title: 'Gráfico Reiniciável com Capturas',
            xaxis: { title: 'Tempo' },
            yaxis: { title: 'ECG', rangemode: 'tozero' }
        };

        const infiniteLayout = {
            title: 'Gráfico Contínuo',
            xaxis: { title: 'Tempo' },
            yaxis: { title: 'ECG', rangemode: 'tozero' }
        };

        Plotly.newPlot('ecgChart', [{
            x: ecgData.x,
            y: ecgData.y,
            mode: 'lines',
            line: { color: 'rgba(75, 192, 192, 1)', width: 2 }
        }], layout);

        Plotly.newPlot('ecgChartInfinite', [{
            x: infiniteEcgData.x,
            y: infiniteEcgData.y,
            mode: 'lines',
            line: { color: 'rgba(192, 75, 75, 1)', width: 2 }
        }], infiniteLayout);

        function simulateECG(t) {
            const restingAmplitude = 0;
            const qrsAmplitude = biphasicMode ? 2 : 1;

            if (restingTime > 0) {
                restingTime--;
                return restingAmplitude;
            } else if (t % heartRate < 0.1) {
                return qrsAmplitude * (abnormalRate ? 1.5 : 1);
            } else if (t % heartRate < 0.2) {
                return -qrsAmplitude * 0.5;
            } else {
                restingTime = 50;
                return restingAmplitude;
            }
        }

        function addDataPoint(ecgValue) {
            ecgData.x.push(xPosition);
            ecgData.y.push(ecgValue);

            infiniteEcgData.x.push(xPosition);
            infiniteEcgData.y.push(ecgValue);

            // Limitar a quantidade de pontos no gráfico contínuo
            if (infiniteEcgData.x.length > 300) {
                infiniteEcgData.x.shift();
                infiniteEcgData.y.shift();
            }

            // Atualiza os gráficos
            Plotly.update('ecgChart', { x: [ecgData.x], y: [ecgData.y] });
            Plotly.update('ecgChartInfinite', { x: [infiniteEcgData.x], y: [infiniteEcgData.y] });

            document.getElementById('textOutput').innerText = `Últimos dados: ECG = ${ecgValue}`;
        }

        function triggerAbnormality() {
            abnormalRate = Math.random() > 0.7;
            biphasicMode = Math.random() > 0.85;
            nextAbnormal = Math.random() * 10;
        }

        function captureECG() {
            Plotly.toImage(document.getElementById('ecgChart'), { format: 'png', width: 400, height: 400 })
                .then(function (imageUrl) {
                    const imgElement = document.createElement('img');
                    imgElement.src = imageUrl;
                    imgElement.classList.add('capture');
                    document.getElementById('capturesContainer').appendChild(imgElement);

                    captureIndex++;
                    if (captureIndex > 5) {
                        const firstCapture = document.getElementById('capturesContainer').firstChild;
                        document.getElementById('capturesContainer').removeChild(firstCapture);
                    }
                });
        }

        document.getElementById('saveButton').addEventListener('click', function () {
            const captures = document.getElementsByClassName('capture');
            for (let i = 0; i < captures.length; i++) {
                const imageUrl = captures[i].src;
                const link = document.createElement('a');
                link.href = imageUrl;
                link.download = `ECG_capture_${i + 1}.png`;
                link.click();
            }
        });

        setInterval(() => {
            if (xPosition > nextAbnormal) {
                triggerAbnormality();
            }
            const ecgValue = simulateECG(xPosition * 1.2);
            addDataPoint(ecgValue);

            // Captura e reinicia o gráfico ao atingir 400 pontos
            if (ecgData.x.length >= 400) {
                captureECG();
                ecgData.x = [];
                ecgData.y = [];
            }

            xPosition++;
        }, 10); // 100 Hz
    </script>
</body>
</html>
